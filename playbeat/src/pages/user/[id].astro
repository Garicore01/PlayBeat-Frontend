---
import Layout from '@layouts/Layout.astro';

import Header from '@components/Header.astro';
import HeaderUser from '@components/HeaderUser.astro';
import TopFive from '@components/TopFive.astro';
import CarrouselUser from '@components/CarrouselUser.astro';
import { getFollowers } from '@/utils/getFollowers';
import { userTopSongs } from '@/utils/userTopSongs';
import { getSongsUser } from "@/utils/getSongsUser";
import { getPodcastUser } from "@/utils/getPodcastUser";

// import { getUserAudios } from '@/utils/getUserAudios';  
import { Global } from "@/globalState/globalUrl.js";

const { id } = Astro.params


let user;
let canciones;
let cancionesAll = [];
let podcastAll = [];


try{
    const jws = Astro.cookies.get('token');
    if(jws !==null && jws !== undefined){
        
        // const responseFollowers = await getFollowers(jws.value, "444");
        const responseFollowers = await getFollowers(jws.value, id);
        user = responseFollowers.data;


        // const responseTop = await userTopSongs(jws.value, 444, 5);
        const responseTop = await userTopSongs(jws.value, Number(id), 5);
        canciones = responseTop.data;
        // console.log(responseTop.data);

        // const responseLast = await getUserAudios(jws.value, Number(id));

        // const responseCanciones = await getSongsUser(444);
        const responseCanciones = await getSongsUser(Number(id));
        cancionesAll = responseCanciones.data.cancion;

        const responsePodcast = await getPodcastUser(Number(id));
        // const responsePodcast = await getPodcastUser(id);

        podcastAll = responsePodcast.data.podcast;




    }
   

} catch (error) {
    if (error instanceof TypeError) {
        console.log('Error: ', error.message);
    } else {
        console.log('Error: ', error);
    }

}

const followers = user.Seguidores;
const following = user.Seguidos;


const fecha = new Date(user.ultimoLanzamiento.fechaLanz);

// Extrae el día, mes y año de la fecha
const dia = String(fecha.getDate()).padStart(2, '0');
const mes = String(fecha.getMonth() + 1).padStart(2, '0');
const anio = fecha.getFullYear();

// Formatea la fecha como DD-MM-YYYY
const fechaFormateada = `${dia}-${mes}-${anio}`;

// Muestra la fecha formateada



// const canciones2 = {items:[{audio:"Cancion1", descripcion:"Artista1"}, {audio:"Cancion2", descripcion:"Artista2"}, {audio:"Cancion3", descripcion:"Artista3"}, {audio:"Cancion4", descripcion:"Artista4"}, {audio:"Cancion5", descripcion:"Artista5"}, {audio:"audio6", descripcion:"Artista6"}, {audio:"audio7", descripcion:"Artista7"}, {audio:"audio8", descripcion:"Artista8"}, {audio:"audio9", descripcion:"Artista9"}, {audio:"audio10", descripcion:"Artista10"}, {audio:"audio11", descripcion:"Artista11"}, {audio:"audio12", descripcion:"Artista12"}, {audio:"audio13", descripcion:"Artista13"}, {audio:"audio14", descripcion:"Artista14"}, {audio:"audio15", descripcion:"Artista15"}, {audio:"audio16", descripcion:"Artista16"}, {audio:"audio17", descripcion:"Artista17"}, {audio:"audio18", descripcion:"Artista18"}, {audio:"audio19", descripcion:"Artista19"}, {audio:"audio20", descripcion:"Artista20"}, {audio:"audio21", descripcion:"Artista21"}, {audio:"audio22", descripcion:"Artista22"}, {audio:"audio23", descripcion:"Artista23"}, {audio:"audio24", descripcion:"Artista24"}, {audio:"audio25", descripcion:"Artista25"}, {audio:"audio26", descripcion:"Artista26"}, {audio:"audio27", descripcion:"Artista27"}, {audio:"audio28", descripcion:"Artista28"}, {audio:"audio29", descripcion:"Artista29"}, {audio:"audio30", descripcion:"Artista30"}, {audio:"audio31", descripcion:"Artista31"}, {audio:"audio32", descripcion:"Artista32"}]}

---

<Layout title="PlayBeat">

	<div class=" flex flex-col w-full   text-white">
		<Header/>
		<div class=" w-full h-full flex flex-col mt-16">
            <HeaderUser nombre={user.nombreUsuario} email={user.email} img={user.imgPerfil} followers={followers} following={following} id={2}/>
			<div class="px-16 mt-10 flex flex-row flex-wrap">
                <section class="w-4/6">
                    <h2 class="text-lg font-semibold">Top canciones</h2>
                    <div>
                        <TopFive info={canciones}/>
                    </div>
                </section>
                <section class=" w-1/8 flex flex-col items-start justify-between ml-16">
                    <div >
                        <h2 class="text-lg font-semibold">Último lanzamiento</h2>
                        <div class="bg-black w-44 h-44 rounded-md mt-4">
                            <img src={`${Global.url}foto/${user.ultimoLanzamiento.imgAudio}`} class="w-full h-full object-cover rounded-md" alt="Ultimo lanzamiento"/>
                            <div class="flex flex-col my-2 mb-3">
                                <h3 class="font-bold">{user.ultimoLanzamiento.titulo}</h3>
                                <p>{fechaFormateada}</p>
                            </div>
                        </div>
                    </div>
                    <hr class=" border-white border-0.5 w-[180px] mt-16"/>
                    <div class="mt-3">
                        <h2 class="text-lg font-semibold ">Popularidad</h2>
                        <span >{user.oyentesMensuales} oyentes mensuales</span>
                    </div>
                </section>
                {
                    cancionesAll.length > 0 && 
                    <section class="mt-10 w-full">
                        <h2 class="text-lg font-semibold ">Discografia</h2>
                        <CarrouselUser audios={cancionesAll} />
                     </section>
                }
                
                {
                    podcastAll.length > 0 &&
                
                    <section class="mt-10 w-full">
                        <h2 class="text-lg font-semibold ">Podcast</h2>
                        <CarrouselUser  audios={podcastAll}/>
                    </section>}
            </div>
		</div>
	</div>

</Layout>




